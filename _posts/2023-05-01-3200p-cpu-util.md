---
layout: post
title: "32,000% CPU Utilization"
date: 2023-05-01 9:00
author: joseph
comments: true
categories: [Java, Server, Connections]
---


# introduction

first fact 3200% CPU utilization. all cores full utilized.


open JDK has elapsed in thread dump

```
"Thread-0" #22 [14700] prio=5 os_prio=0 cpu=10359.38ms elapsed=11.49s tid=0x000001cdc35aaf60 nid=14700 runnable  [0x00000047cfffe000]
   java.lang.Thread.State: RUNNABLE
	at java.util.TreeMap.put(java.base@19.0.1/TreeMap.java:826)
	at java.util.TreeMap.put(java.base@19.0.1/TreeMap.java:534)
	at SimpleRepro.lambda$main$0(SimpleRepro.java:29)
	at SimpleRepro$$Lambda$14/0x00000008010031f0.run(Unknown Source)
	at java.lang.Thread.run(java.base@19.0.1/Thread.java:1589)
```

Red herring

```
public void someFunction(SomeType relatedObject, List<SomeOtherType> relatedObject) {
  for (SomeOtherType unrelatedObject : unrelatedObjects) {
    treeMap.put(relatedObject.a(), relatedObject.b());
  }
}
```

- talk about on further thought
  - the complexity of this loop is O(whatever)
  - etc

Aha moment
- browsing the rest of the class and notice that there are locks
- did we grab the lock before tree map?
- NO!!!

# experiment

```
threads.add(new Thread(() -> {
    Random random = new Random();
    for(int j = 0; j < numUpdates; j++) {
        try {
            treeMap.put(random.nextInt(1000), random.nextInt(1000));
        } catch (NullPointerException e) {
            // let it keep going so we can reproduce the issue.
        }
    }
}));
```

That's crazy! I always thought of race conditions as corrupting the data. I never though it could cause performance issues.


![example cycle generated from TreeMap experiment](/assets/2023-08-20_cpu_util_3200/red_black_tree_cycle.gv.svg)

# That code is not realistic

Is this code realistic? Who ignores NPEs?
Well we could reproduce this problem with a simple grpc service.

# Other languages

| Language   | Affected | Explanation | Code |
|------------|----------|-------------|------|
| Javscript  | no       | [multithreading model cannot share references](https://stackoverflow.com/questions/40028377/is-it-possible-to-achieve-multithreading-in-nodejs) | |
| Python     | no       | no red-black tree in standard libary and popular libraries like [Sorted Containers do not use red black tree](https://grantjenks.com/docs/sortedcontainers/implementation.html) |
| Typescript | no       | same argument as javascript|
| Java       | yes      | this whole article is based on this | TODO |
| C#         | yes      | [SortedDictionary](https://stackoverflow.com/questions/14909853/is-sorteddictionary-a-red-black-tree) used red black tree | TODO |
| C++        | maybe    | [used red-black tree](https://stackoverflow.com/questions/18414579/what-data-structure-is-inside-stdmap-in-c) but not sure how to get around seg fault | TODO |
| PHP        | no       | not in standard library and did not find any popular libraries   |
| Go         | maybe         | [has popular datastructures library](https://github.com/emirpasic/gods#redblacktree) but don't know enough about go's memory model. will it segfault or will it give an error I can ignore?     | TODO |
| Rust       |          | no red black tree. uses [BTree instead](https://doc.rust-lang.org/std/collections/struct.BTreeMap.html). also ownership model prevents this sort of issue, unless you use unsafe     |
| Kotlin     | yes      | uses java's TreeMap     | TODO |
| Ruby       | maybe       | popular 3rd party library [kanwei/algorithms](http://kanwei.github.io/algorithms/classes/Containers/RubyRBTreeMap.html) uses red black tree     | TODO |

# How did it happen? Rotations


# how to fix easy

# how to fix controvsial



# Conclusion
Conclusion summary? what to say?
