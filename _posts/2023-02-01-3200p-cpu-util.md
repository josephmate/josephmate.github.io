
introduction

first fact


open JDK has elapsed in thread dump

"Thread-0" #22 [14700] prio=5 os_prio=0 cpu=10359.38ms elapsed=11.49s tid=0x000001cdc35aaf60 nid=14700 runnable  [0x00000047cfffe000]
   java.lang.Thread.State: RUNNABLE
	at java.util.TreeMap.put(java.base@19.0.1/TreeMap.java:826)
	at java.util.TreeMap.put(java.base@19.0.1/TreeMap.java:534)
	at SimpleRepro.lambda$main$0(SimpleRepro.java:29)
	at SimpleRepro$$Lambda$14/0x00000008010031f0.run(Unknown Source)
	at java.lang.Thread.run(java.base@19.0.1/Thread.java:1589)


Red herring

```
public void someFunction(SomeType relatedObject, List<SomeOtherType> relatedObject) {
  for (SomeOtherType unrelatedObject : unrelatedObjects) {
    treeMap.put(relatedObject.a(), relatedObject.b());
  }
}
```

- talk about on further thought
  - the complexity of this loop is O(whatever)
  - etc

Aha moment
- browsing the rest of the class and notice that there are locks
- did we grab the lock before tree map?
- NO!!!

put together experimental code

DONE: write code to repro
TODO: link here
```
threads.add(new Thread(() -> {
    Random random = new Random();
    for(int j = 0; j < numUpdates; j++) {
        try {
            treeMap.put(random.nextInt(1000), random.nextInt(1000));
        } catch (NullPointerException e) {
            // let it keep going so we can reproduce the issue.
        }
    }
}));
```

That's crazy! I always thought of race conditions as corrupting the data. I never though it could cause performance issues.

TODO: write code to detect loop

1. wrote code that navigates the tree
2. tried to look for a loop of entries by using IdentityHashMap (which uses == instead of .equals())
3. did not detect a loop
4. does that mean there is some local variable that creates the loop?
    1. if so, it will be really difficult to dump a graph that visualizes the issue
    2. if so, maybe we attach debugger and try to manually create the graph?

TODO: write code to draw graph

TODO: write code to draw graph just before loop detected

TODO: Understand the treemap algorithm (red-black tree?)
    conflicting rotations?

TODO: simple diagrams that demonstrate the concurrent rotation issue

TODO: how to fix easy

TODO: how to fix controvsial

Conclusion summary? what to say?